<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Balances</title>

  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      margin: 0;
    }

    h1 { margin-top: 0; }

    /* ===== MAIN LAYOUT (LEFT USERS + RIGHT CONTENT) ===== */
    .page {
      display: flex;
      gap: 20px;
      align-items: flex-start;
    }

    /* ===== LEFT USERS LIST ===== */
    .sidebar {
      width: 350px;
      border: 1px solid #ccc;
      border-radius: 6px;
      padding: 12px;
      position: sticky;
      top: 20px;
      background: #fff;
    }

    .sidebar h2 {
      margin: 0 0 10px 0;
      font-size: 18px;
    }

    .sidebar .row {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-bottom: 10px;
    }

    .sidebar input {
      padding: 5px;
      width: 100%;
      box-sizing: border-box;
    }

    .usersList {
      list-style: none;
      padding: 0;
      margin: 0;
      max-height: 70vh;
      overflow: auto;
      border-top: 1px solid #eee;
      padding-top: 10px;
    }

    .usersList li {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      padding: 8px;
      border: 1px solid #eee;
      border-radius: 6px;
      margin-bottom: 8px;
    }

    .usersList li:hover {
      background: #fafafa;
    }

    .userText {
      font-size: 14px;
      line-height: 1.2;
    }

    .userActions {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .smallBtn {
      padding: 4px 10px;
      cursor: pointer;
    }

    /* ===== RIGHT CONTENT BOXES ===== */
    .content {
      flex: 1;
      min-width: 320px;
    }

    /* ===== BOXES GRID ===== */
    .container {
      display: flex;
      gap: 20px;
      align-items: flex-start;
      flex-wrap: wrap; /* —á—Ç–æ–±—ã –Ω–∞ —É–∑–∫–æ–º —ç–∫—Ä–∞–Ω–µ –ø–µ—Ä–µ–Ω–æ—Å–∏–ª–æ—Å—å */
    }

    .box {
      border: 1px solid #ccc;
      padding: 15px;
      width: 300px;
      border-radius: 6px;
      background: #fff;
    }

    label {
      display: block;
      margin-top: 10px;
    }

    input {
      padding: 5px;
      width: 100%;
      box-sizing: border-box;
    }

    button {
      margin-top: 10px;
      padding: 6px 12px;
      cursor: pointer;
    }

    /* ===== RESULT MESSAGE ===== */
    .result {
      margin-top: 15px;
      padding: 10px;
      border-radius: 5px;
      display: none;
      white-space: pre-wrap; /* —á—Ç–æ–±—ã —Ç–µ–∫—Å—Ç –æ—à–∏–±–æ–∫ –∫—Ä–∞—Å–∏–≤–æ –ø–µ—Ä–µ–Ω–æ—Å–∏–ª—Å—è */
    }

    .result.success {
      display: block;
      background: #e6ffed;
      border: 1px solid #2ecc71;
      color: #1e8449;
    }

    .result.error {
      display: block;
      background: #ffecec;
      border: 1px solid #e74c3c;
      color: #922b21;
    }

    /* ===== SMALL HELP TEXT ===== */
    .muted {
      color: #666;
      font-size: 12px;
      margin-top: 8px;
      line-height: 1.3;
    }

    /* Responsive */
    @media (max-width: 900px) {
      .page { flex-direction: column; }
      .sidebar { width: auto; position: static; }
    }
  </style>
</head>
<body>

<h1>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞–º–∏</h1>

<div class="page">

  <!-- ===== LEFT: USERS LIST ===== -->
  <aside class="sidebar">
    <h2>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h2>

    <div class="row">
      <input id="userSearch" placeholder="–ü–æ–∏—Å–∫ –ø–æ login –∏–ª–∏ ID..." oninput="filterUsers()" />
      <button class="smallBtn" onclick="loadUsers()">–û–±–Ω–æ–≤–∏—Ç—å</button>
    </div>

    <div class="muted">
      –ö–Ω–æ–ø–∫–∞ <b>–í—ã–±—Ä–∞—Ç—å</b> –ø–æ–¥—Å—Ç–∞–≤–∏—Ç ID –≤ –ø–æ–ª–µ <b>User ID</b> –∏ –ø–æ–∫–∞–∂–µ—Ç –±–∞–ª–∞–Ω—Å.
    </div>

    <ul id="users" class="usersList"></ul>
  </aside>

  <!-- ===== RIGHT: BALANCES UI ===== -->
  <main class="content">
    <div class="container">

      <!-- ===== BALANCE ===== -->
      <div class="box">
        <h2>–ë–∞–ª–∞–Ω—Å</h2>

        <label>
          User ID:
          <input id="userId" type="number" min="1">
        </label>

        <button onclick="loadBalance()">–ü–æ–∫–∞–∑–∞—Ç—å –±–∞–ª–∞–Ω—Å</button>

        <div id="balanceBox" style="margin-top:10px;"></div>
      </div>

      <!-- ===== ADD BALANCE ===== -->
      <div class="box">
        <h2>–ù–∞—á–∏—Å–ª–∏—Ç—å</h2>

        <label>
          –°—É–º–º–∞:
          <input id="addAmount" type="number" min="1">
        </label>

        <button onclick="addBalance()">–ù–∞—á–∏—Å–ª–∏—Ç—å</button>
      </div>

      <!-- ===== TRANSFER ===== -->
      <div class="box">
        <h2>–ü–µ—Ä–µ–≤–æ–¥</h2>

        <label>
          –û—Ç (User ID):
          <input id="fromUserId" type="number" min="1">
        </label>

        <label>
          –ö–æ–º—É (User ID):
          <input id="toUserId" type="number" min="1">
        </label>

        <label>
          –°—É–º–º–∞:
          <input id="amount" type="number" min="1" step="1">
        </label>

        <button onclick="transfer()">–ü–µ—Ä–µ–≤–µ—Å—Ç–∏</button>

        <div id="transferResult" class="result"></div>
      </div>

    </div>
  </main>

</div>

<script>
  // ====== USERS LIST (–∫–∞–∫ –≤ users.html) ======
  let ALL_USERS = [];

  async function loadUsers() {
    const ul = document.getElementById('users');
    ul.innerHTML = '<li>–ó–∞–≥—Ä—É–∑–∫–∞...</li>';

    let res;
    try {
      res = await fetch('/users');
    } catch (e) {
      ul.innerHTML = '<li>–û—à–∏–±–∫–∞: —Å–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω</li>';
      return;
    }

    if (!res.ok) {
      ul.innerHTML = `<li>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ${await res.text()}</li>`;
      return;
    }

    const users = await res.json();
    ALL_USERS = Array.isArray(users) ? users : [];
    renderUsers(ALL_USERS);
  }

  function renderUsers(users) {
    const ul = document.getElementById('users');
    ul.innerHTML = '';

    if (!users.length) {
      ul.innerHTML = '<li>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–µ—Ç</li>';
      return;
    }

    users.forEach(user => {
      const li = document.createElement('li');

      const text = document.createElement('div');
      text.className = 'userText';
      text.innerHTML = `<b>#${user.id}</b> ‚Äî ${user.login}`;
      li.appendChild(text);

      const actions = document.createElement('div');
      actions.className = 'userActions';

      // ‚úÖ –í—ã–±—Ä–∞—Ç—å (–ø–æ–¥—Å—Ç–∞–≤–ª—è–µ—Ç ID –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –±–∞–ª–∞–Ω—Å)
      const pickBtn = document.createElement('button');
      pickBtn.className = 'smallBtn';
      pickBtn.textContent = '–í—ã–±—Ä–∞—Ç—å';
      pickBtn.onclick = async () => {
        document.getElementById('userId').value = user.id;
        await loadBalance();
      };

      // üóë –£–¥–∞–ª–∏—Ç—å (–∫–∞–∫ –≤ users.html)
      const deleteBtn = document.createElement('button');
      deleteBtn.className = 'smallBtn';
      deleteBtn.textContent = '–£–¥–∞–ª–∏—Ç—å';
      deleteBtn.onclick = async () => {
        if (!confirm('–£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?')) return;

        const delRes = await fetch(`/users/${user.id}`, { method: 'DELETE' });
        if (!delRes.ok) {
          alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + await delRes.text());
          return;
        }
        loadUsers();
      };

      actions.appendChild(pickBtn);
      actions.appendChild(deleteBtn);

      li.appendChild(actions);
      ul.appendChild(li);
    });
  }

  function filterUsers() {
    const q = (document.getElementById('userSearch').value || '').trim().toLowerCase();
    if (!q) {
      renderUsers(ALL_USERS);
      return;
    }

    const filtered = ALL_USERS.filter(u => {
      const idStr = String(u.id ?? '');
      const loginStr = String(u.login ?? '').toLowerCase();
      return idStr.includes(q) || loginStr.includes(q);
    });

    renderUsers(filtered);
  }

  // ====== BALANCES UI ======
  function showResult(el, type, message) {
    el.className = 'result ' + type; // success | error
    el.innerHTML = message;
    el.style.display = 'block';
  }

  async function loadBalance() {
    const userId = document.getElementById('userId').value;
    const box = document.getElementById('balanceBox');

    if (!userId) {
      box.innerText = '–í–≤–µ–¥–∏—Ç–µ User ID';
      return;
    }

    const res = await fetch(`${window.location.origin}/balances/${userId}`);

    if (!res.ok) {
      box.innerText = '–û—à–∏–±–∫–∞: ' + await res.text();
      return;
    }

    const data = await res.json();

    box.innerHTML = `
      <p><b>–õ–æ–≥–∏–Ω:</b> ${data?.user?.login ?? '(–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö)'}</p>
      <p><b>–ë–∞–ª–∞–Ω—Å:</b> üí∞ ${data.amount}</p>
    `;
  }

  async function addBalance() {
    const userId = Number(document.getElementById('userId').value);
    const amount = Number(document.getElementById('addAmount').value);

    if (!Number.isInteger(userId) || userId <= 0) {
      alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π User ID');
      return;
    }

    if (!Number.isFinite(amount) || amount <= 0) {
      alert('–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –±–æ–ª—å—à–µ 0');
      return;
    }

    const res = await fetch(`${window.location.origin}/balances/${userId}/add/${amount}`, {
      method: 'POST',
    });

    if (!res.ok) {
      alert('–û—à–∏–±–∫–∞ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è: ' + await res.text());
      return;
    }

    await loadBalance();
  }

  async function transfer() {
    const fromUserId = Number(document.getElementById('fromUserId').value);
    const toUserId = Number(document.getElementById('toUserId').value);
    const amount = Number(document.getElementById('amount').value);

    const resultBox = document.getElementById('transferResult');

    // –í–∞–ª–∏–¥–∞—Ü–∏—è (—á—Ç–æ–±—ã –Ω–µ —Å–ª–∞—Ç—å NaN)
    if (!Number.isInteger(fromUserId) || fromUserId <= 0) {
      showResult(resultBox, 'error', '‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π "–û—Ç (User ID)"');
      return;
    }
    if (!Number.isInteger(toUserId) || toUserId <= 0) {
      showResult(resultBox, 'error', '‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π "–ö–æ–º—É (User ID)"');
      return;
    }
    if (fromUserId === toUserId) {
      showResult(resultBox, 'error', '‚ùå –ù–µ–ª—å–∑—è –ø–µ—Ä–µ–≤–æ–¥–∏—Ç—å —Å–∞–º–æ–º—É —Å–µ–±–µ');
      return;
    }
    if (!Number.isFinite(amount) || amount <= 0) {
      showResult(resultBox, 'error', '‚ùå –°—É–º–º–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –±–æ–ª—å—à–µ 0');
      return;
    }

    const url = `${window.location.origin}/balances/transfer`;

    let res;
    try {
      res = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ fromUserId, toUserId, amount }),
      });
    } catch (e) {
      showResult(resultBox, 'error', '‚ùå –°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (fetch error)');
      return;
    }

    const text = await res.text();

    if (!res.ok) {
      showResult(resultBox, 'error', `‚ùå –û—à–∏–±–∫–∞ (${res.status}): ${text}`);
      return;
    }

    showResult(resultBox, 'success', `‚úÖ –ü–µ—Ä–µ–≤–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ`);

    // –ê–≤—Ç–æ-–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞, –µ—Å–ª–∏ –≤ –ø–æ–ª–µ User ID —Å—Ç–æ–∏—Ç –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å/–ø–æ–ª—É—á–∞—Ç–µ–ª—å
    const currentUserId = Number(document.getElementById('userId').value);
    if (currentUserId === fromUserId || currentUserId === toUserId) {
      await loadBalance();
    }
  }

  // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ —é–∑–µ—Ä–æ–≤ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
  window.onload = loadUsers;
</script>

</body>
</html>
